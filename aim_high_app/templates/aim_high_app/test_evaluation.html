{% extends "aim_high_app/base.html" %}

{% block page_name %}test_evaluation{% endblock %}

{% block content %}
<div class="go-back">
    <a href="/" id="back-to-class">&larr; Go back to the Class</a>
</div>

<div class="evaluation-container">
    <div class="evaluation-header">
        <h2>Evaluation Assignment</h2>
    </div>

    <div class="evaluation-section">
        <div class="evaluation-title">
            <h3>3.4 Unique Characteristics of Eukaryotic Cells</h3>
        </div>
        
        <div id="evaluation-accordion">
            <!-- Previous Attempts Section -->
            <div class="accordion-item active">
                <div class="accordion-header">
                    <div class="accordion-icon">
                        <span class="checkmark">✓</span>
                    </div>
                    <h4>Your Previous Attempts</h4>
                    <span class="accordion-toggle">▾</span>
                </div>
                <div class="accordion-content" style="display: block;">
                    <div id="previous-attempts" class="previous-attempts">
                        <p class="no-attempts-message">You haven't submitted any attempts yet. Write a summary and click "Evaluate" to see your results.</p>
                    </div>
                </div>
            </div>

            <!-- Learning Material Section -->
            <div class="accordion-item active">
                <div class="accordion-header">
                    <div class="accordion-icon">
                        <span class="checkmark">✓</span>
                    </div>
                    <h4>Learning Material</h4>
                    <span class="accordion-toggle">▾</span>
                </div>
                <div class="accordion-content" style="display: block;">
                    <div id="material-content" class="content-preview">
                        <p>Eukaryotic cells are characterized by a complex nuclear membrane. Also, eukaryotic cells are characterized by the presence of membrane-bound organelles in the cytoplasm. Organelles such as mitochondria, the endoplasmic reticulum (ER), Golgi apparatus, lysosomes, and peroxisomes are held in place by the cytoskeleton, an internal network that directs transport of intracellular components and helps maintain cell shape (Figure 3.35). The genome of eukaryotic cells is packaged in multiple, rod-shaped chromosomes as opposed to the single, circular-shaped chromosome that characterizes most prokaryotic cells. Table 3.2 compares the characteristics of eukaryotic cell structures with those of bacteria and archaea.</p>
                    </div>
                </div>
            </div>
            
            <!-- Write Your Summary Section -->
            <div class="accordion-item active">
                <div class="accordion-header">
                    <div class="accordion-icon">
                        <span class="checkmark">✓</span>
                    </div>
                    <h4>Write your Summary</h4>
                    <span class="accordion-toggle">▾</span>
                </div>
                <div class="accordion-content" style="display: block;">
                    <div class="text-area-container">
                        <textarea id="student-summary" placeholder="Write your summary of the learning material here..."></textarea>
                    </div>
                    <div class="evaluation-buttons">
                        <button id="reset-summary" class="secondary-button">Reset</button>
                        <button id="evaluate-summary" class="primary-button">Evaluate</button>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Section -->
            <div class="accordion-item active">
                <div class="accordion-header">
                    <div class="accordion-icon">
                        <span class="checkmark">✓</span>
                    </div>
                    <h4>Feedback on Your Summary</h4>
                    <span class="accordion-toggle">▾</span>
                </div>
                <div class="accordion-content" style="display: block;">
                    <div class="progress-container">
                        <div class="progress-label">Progress</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 7%;"></div>
                        </div>
                        <div class="progress-percentage">7%</div>
                    </div>
                    
                    <div class="knowledge-map-container">
                        <h3>Your Knowledge Map</h3>
                        <div id="knowledge-map" class="knowledge-map"></div>
                    </div>
                    
                    <div class="missing-concepts">
                        <h3>Missing Concepts</h3>
                        <div class="concept-grid" id="missing-concepts-grid">
                            <!-- Missing concepts will be populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="feedback-section">
                        <div class="feedback-header">
                            <div class="feedback-title">Content Quality:</div>
                            <div class="star-rating">
                                <span class="star filled">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                            </div>
                        </div>
                        <div class="feedback-content">
                            <p>Evaluates the accuracy, completeness, and clarity of the summary. A high quality summary captures key ideas concisely, maintains factual accuracy, and presents information logically without unnecessary details or omissions.</p>
                            <div class="improvement-section">
                                <div class="improvement-title">How To Improve:</div>
                                <p>Please write a summary and click the "Evaluate" button to receive personalized feedback.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attempt Details Modal -->
<div id="attempt-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Summary Attempt Details</h2>
        
        <div class="attempt-details">
            <div class="attempt-date">
                <strong>Date:</strong> <span id="modal-date"></span>
            </div>
            
            <div class="attempt-score">
                <strong>Score:</strong> <span id="modal-score"></span>
            </div>
            
            <div class="attempt-summary">
                <h3>Your Summary</h3>
                <div id="modal-summary" class="modal-text-content"></div>
            </div>
            
            <div class="attempt-feedback">
                <h3>Feedback</h3>
                <div id="modal-feedback" class="modal-text-content"></div>
            </div>
            
            <div class="attempt-improvement">
                <h3>How To Improve</h3>
                <div id="modal-improvement" class="modal-text-content"></div>
            </div>
            
            <div class="attempt-concepts">
                <h3>Missing Concepts</h3>
                <div id="modal-missing-concepts" class="concept-grid"></div>
            </div>
            
            <div class="attempt-knowledge-map">
                <h3>Knowledge Map</h3>
                <div id="modal-knowledge-map" class="knowledge-map"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Previous attempts section */
.previous-attempts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.attempt-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background-color: #f5f5f5;
    border-radius: 4px;
    border-left: 4px solid #3498db;
    cursor: pointer;
    transition: background-color 0.2s;
}

.attempt-card:hover {
    background-color: #e3f2fd;
}

.attempt-info {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.attempt-score {
    font-weight: bold;
    padding: 0.25rem 0.5rem;
    background-color: #3498db;
    color: white;
    border-radius: 4px;
}

.attempt-date {
    color: #555;
    font-size: 0.9rem;
}

.attempt-preview {
    color: #555;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 400px;
}

.no-attempts-message {
    color: #888;
    font-style: italic;
    text-align: center;
    padding: 1rem;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 2rem;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 8px;
    max-height: 85vh;
    overflow-y: auto;
}

.close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-modal:hover {
    color: black;
}

.attempt-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1rem;
}

.modal-text-content {
    background-color: #f9f9f9;
    padding: 1rem;
    border-radius: 4px;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize knowledge map
    createKnowledgeMap();
    
    // Setup evaluation functionality
    const studentSummary = document.getElementById('student-summary');
    const evaluateButton = document.getElementById('evaluate-summary');
    const resetButton = document.getElementById('reset-summary');
    const progressFill = document.querySelector('.progress-fill');
    const progressPercentage = document.querySelector('.progress-percentage');
    const starRating = document.querySelector('.star-rating');
    const feedbackContent = document.querySelector('.feedback-content p');
    const improvementContent = document.querySelector('.improvement-section p');
    const missingConceptsGrid = document.getElementById('missing-concepts-grid');
    const previousAttemptsContainer = document.getElementById('previous-attempts');
    
    // Clear the missing concepts grid initially
    missingConceptsGrid.innerHTML = '';
    
    // Set up modal
    const modal = document.getElementById('attempt-modal');
    const closeModalBtn = document.querySelector('.close-modal');
    
    closeModalBtn.onclick = function() {
        modal.style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
    // Initialize attempts array in localStorage if it doesn't exist
    if (!localStorage.getItem('summaryAttempts')) {
        localStorage.setItem('summaryAttempts', JSON.stringify([]));
    }
    
    // Load previous attempts
    loadPreviousAttempts();
    
    // Expert model - Key concepts that should be included in a summary about eukaryotic cells
    const expertConcepts = [
        "Nuclear Membrane", 
        "Membrane-bound Organelles",
        "Mitochondria", 
        "Endoplasmic Reticulum", 
        "Golgi Apparatus", 
        "Lysosomes", 
        "Peroxisomes", 
        "Cytoskeleton",
        "Intracellular Transport",
        "Rod-shaped Chromosomes"
    ];
    
    // Evaluate button click handler
    if (evaluateButton) {
        evaluateButton.addEventListener('click', function() {
            const summary = studentSummary.value.trim();
            
            if (!summary) {
                alert('Please write a summary before evaluating.');
                return;
            }
            
            // Process summary to calculate score and generate feedback
            processStudentSummary(summary);
        });
    }
    
    // Reset button click handler
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            studentSummary.value = '';
            updateProgress(7);
            updateStars(1);
            
            feedbackContent.textContent = 'Evaluates the accuracy, completeness, and clarity of the summary. A high quality summary captures key ideas concisely, maintains factual accuracy, and presents information logically without unnecessary details or omissions.';
            
            improvementContent.textContent = 'Please write a summary and click the "Evaluate" button to receive personalized feedback.';
            
            // Clear missing concepts
            missingConceptsGrid.innerHTML = '';
            
            // Reset knowledge map
            createKnowledgeMap(); 
        });
    }
    
    // Function to load previous attempts
    function loadPreviousAttempts() {
        const attempts = JSON.parse(localStorage.getItem('summaryAttempts')) || [];
        
        // Clear previous attempts container
        previousAttemptsContainer.innerHTML = '';
        
        if (attempts.length === 0) {
            previousAttemptsContainer.innerHTML = '<p class="no-attempts-message">You haven\'t submitted any attempts yet. Write a summary and click "Evaluate" to see your results.</p>';
            return;
        }
        
        // Sort attempts by date, newest first
        attempts.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Create attempt cards
        attempts.forEach((attempt, index) => {
            const attemptCard = document.createElement('div');
            attemptCard.className = 'attempt-card';
            attemptCard.dataset.index = index;
            
            // Format date for display
            const attemptDate = new Date(attempt.date);
            const formattedDate = attemptDate.toLocaleDateString() + ' ' + attemptDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Create attempt card HTML
            attemptCard.innerHTML = `
                <div class="attempt-info">
                    <div class="attempt-score">${attempt.score}%</div>
                    <div class="attempt-date">${formattedDate}</div>
                </div>
                <div class="attempt-preview">${attempt.summary.substring(0, 80)}${attempt.summary.length > 80 ? '...' : ''}</div>
            `;
            
            // Add click event to show attempt details
            attemptCard.addEventListener('click', function() {
                showAttemptDetails(index);
            });
            
            previousAttemptsContainer.appendChild(attemptCard);
        });
    }
    
    // Function to show attempt details in modal
    function showAttemptDetails(index) {
        const attempts = JSON.parse(localStorage.getItem('summaryAttempts')) || [];
        const attempt = attempts[index];
        
        if (!attempt) return;
        
        // Set modal content
        document.getElementById('modal-date').textContent = new Date(attempt.date).toLocaleString();
        document.getElementById('modal-score').textContent = attempt.score + '%';
        document.getElementById('modal-summary').textContent = attempt.summary;
        document.getElementById('modal-feedback').textContent = attempt.feedback;
        document.getElementById('modal-improvement').textContent = attempt.improvement;
        
        // Set missing concepts
        const modalMissingConcepts = document.getElementById('modal-missing-concepts');
        modalMissingConcepts.innerHTML = '';
        
        if (attempt.missingConcepts.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'no-missing-concepts';
            placeholder.textContent = 'Great job! You covered all the key concepts.';
            modalMissingConcepts.appendChild(placeholder);
        } else {
            attempt.missingConcepts.forEach(concept => {
                const conceptItem = document.createElement('div');
                conceptItem.className = 'concept-item';
                conceptItem.textContent = concept;
                modalMissingConcepts.appendChild(conceptItem);
            });
        }
        
        // Create knowledge map in modal
        setTimeout(() => {
            createModalKnowledgeMap(attempt.includedConcepts, attempt.missingConcepts);
        }, 100);
        
        // Show modal
        modal.style.display = 'block';
    }
    
    // Function to create knowledge map in modal
    function createModalKnowledgeMap(includedConcepts, missingConcepts) {
        const width = document.getElementById('modal-knowledge-map').clientWidth;
        const height = 250;
        
        // Clear previous SVG
        d3.select('#modal-knowledge-map').html('');
        
        const svg = d3.select('#modal-knowledge-map')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // Create nodes for all concepts
        const nodes = [
            ...includedConcepts.map(name => ({ id: name.replace(/\s+/g, '_'), name, included: true })),
            ...missingConcepts.map(name => ({ id: name.replace(/\s+/g, '_'), name, included: false }))
        ];
        
        // Create links between concepts
        const links = [];
        
        // Connect Nuclear Membrane to related concepts
        if (nodes.find(n => n.id === 'Nuclear_Membrane')) {
            if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
                links.push({ source: 'Nuclear_Membrane', target: 'Membrane-bound_Organelles', type: "related" });
            }
            if (nodes.find(n => n.id === 'Rod-shaped_Chromosomes')) {
                links.push({ source: 'Nuclear_Membrane', target: 'Rod-shaped_Chromosomes', type: "contains" });
            }
        }
        
        // Connect Cytoskeleton to related concepts
        if (nodes.find(n => n.id === 'Cytoskeleton')) {
            if (nodes.find(n => n.id === 'Intracellular_Transport')) {
                links.push({ source: 'Cytoskeleton', target: 'Intracellular_Transport', type: "enables" });
            }
            if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
                links.push({ source: 'Cytoskeleton', target: 'Membrane-bound_Organelles', type: "organizes" });
            }
        }
        
        // Connect Membrane-bound Organelles to specific organelles
        if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
            ['Mitochondria', 'Endoplasmic_Reticulum', 'Golgi_Apparatus', 'Lysosomes', 'Peroxisomes'].forEach(org => {
                if (nodes.find(n => n.id === org)) {
                    links.push({ source: 'Membrane-bound_Organelles', target: org, type: "includes" });
                }
            });
        }
        
        // Create a force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(80))
            .force("charge", d3.forceManyBody().strength(-150))
            .force("center", d3.forceCenter(width / 2, height / 2));
        
        // Add links
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("stroke", "#3498db")
            .attr("stroke-opacity", 0.6)
            .attr("stroke-width", 2);
        
        // Add nodes
        const node = svg.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("circle")
            .attr("r", 10)
            .attr("fill", d => d.included ? "#3498db" : "#f2994a")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // Add node labels
        const label = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .enter()
            .append("text")
            .text(d => d.name)
            .attr("font-size", "10px")
            .attr("dx", 12)
            .attr("dy", 4);
        
        // Update positions on tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
    
    // Function to process the student summary
    function processStudentSummary(summary) {
        // Send summary to server for evaluation
        const csrftoken = getCookie('csrftoken');
        
        // First identify included concepts based on the content
        const includedConcepts = expertConcepts.filter(concept => 
            summary.toLowerCase().includes(concept.toLowerCase()) ||
            summary.toLowerCase().includes(concept.split('-')[0].toLowerCase())
        );
        
        // Calculate similarity score based on concept coverage
        const conceptCoverage = Math.min(100, Math.round((includedConcepts.length / expertConcepts.length) * 100));
        
        // Calculate a length-based component for the score
        const wordCount = summary.split(/\s+/).length;
        const lengthFactor = wordCount < 30 ? 0.6 : wordCount > 100 ? 1.0 : 0.8;
        
        // Calculate final score
        const overallScore = Math.round(conceptCoverage * lengthFactor);
        
        // Identify missing concepts
        const missingConcepts = expertConcepts.filter(concept => !includedConcepts.includes(concept));
        
        // Update UI elements
        updateProgress(overallScore);
        
        const stars = getStarsBasedOnScore(overallScore);
        updateStars(stars);
        
        // Generate feedback
        const feedback = generateFeedback(overallScore, includedConcepts, missingConcepts);
        feedbackContent.textContent = feedback.content;
        improvementContent.textContent = feedback.improvement;
        
        // Update missing concepts grid
        updateMissingConcepts(missingConcepts);
        
        // Update knowledge map
        updateKnowledgeMap(includedConcepts, missingConcepts);
        
        // Add chat message
        addChatMessage(overallScore, includedConcepts, missingConcepts);
        
        // Save this attempt to localStorage
        saveAttempt(summary, overallScore, includedConcepts, missingConcepts, feedback.content, feedback.improvement);
    }
    
    // Function to save attempt to localStorage
    function saveAttempt(summary, score, includedConcepts, missingConcepts, feedback, improvement) {
        // Get existing attempts
        const attempts = JSON.parse(localStorage.getItem('summaryAttempts')) || [];
        
        // Add new attempt
        attempts.push({
            summary: summary,
            score: score,
            includedConcepts: includedConcepts,
            missingConcepts: missingConcepts,
            feedback: feedback,
            improvement: improvement,
            date: new Date().toISOString()
        });
        
        // Save back to localStorage
        localStorage.setItem('summaryAttempts', JSON.stringify(attempts));
        
        // Refresh the attempts display
        loadPreviousAttempts();
    }
    
    // Function to get star rating based on score
    function getStarsBasedOnScore(score) {
        if (score >= 90) return 5;
        if (score >= 70) return 4;
        if (score >= 50) return 3;
        if (score >= 30) return 2;
        return 1;
    }
    
    // Function to generate feedback based on score and concepts
    function generateFeedback(score, includedConcepts, missingConcepts) {
        let content, improvement;
        
        if (score < 30) {
            content = "Your summary captures only a few key points and lacks completeness.";
            improvement = `Focus on including the main characteristics of eukaryotic cells: ${missingConcepts.slice(0, 3).join(', ')}, and other key features.`;
        } else if (score < 50) {
            content = "Your summary includes some important concepts but misses several key details.";
            improvement = `Add more specific information about: ${missingConcepts.slice(0, 3).join(', ')}.`;
        } else if (score < 70) {
            content = "Your summary covers many important aspects of eukaryotic cells but could be more comprehensive.";
            improvement = missingConcepts.length > 0 
                ? `Consider adding details about: ${missingConcepts.join(', ')}.` 
                : "Try to expand on the relationships between the concepts you've mentioned.";
        } else if (score < 90) {
            content = "Your summary is good and covers most key characteristics accurately.";
            improvement = missingConcepts.length > 0 
                ? `To further improve, ensure you mention: ${missingConcepts.join(', ')}.` 
                : "Consider clarifying how the different organelles work together within the cell.";
        } else {
            content = "Excellent summary that comprehensively covers all key characteristics of eukaryotic cells.";
            improvement = "Your summary effectively captures all the essential information with clarity and accuracy.";
        }
        
        return { content, improvement };
    }
    
    // Function to update progress bar
    function updateProgress(score) {
        progressFill.style.width = score + '%';
        progressPercentage.textContent = score + '%';
    }
    
    // Function to update star rating
    function updateStars(numFilled) {
        const stars = starRating.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
            if (index < numFilled) {
                star.classList.add('filled');
            } else {
                star.classList.remove('filled');
            }
        });
    }
    
    // Function to update missing concepts display
    function updateMissingConcepts(missingConcepts) {
        missingConceptsGrid.innerHTML = '';
        
        if (missingConcepts.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'no-missing-concepts';
            placeholder.textContent = 'Great job! You covered all the key concepts.';
            missingConceptsGrid.appendChild(placeholder);
            return;
        }
        
        missingConcepts.forEach(concept => {
            const conceptItem = document.createElement('div');
            conceptItem.className = 'concept-item';
            conceptItem.textContent = concept;
            missingConceptsGrid.appendChild(conceptItem);
        });
    }
    
    // Function to create initial knowledge map
    function createKnowledgeMap() {
        const width = document.getElementById('knowledge-map').clientWidth;
        const height = document.getElementById('knowledge-map').clientHeight || 250;
        
        // Clear previous SVG
        d3.select('#knowledge-map').html('');
        
        const svg = d3.select('#knowledge-map')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
            
        // Add placeholder text
        svg.append("text")
           .attr("x", width / 2)
           .attr("y", height / 2)
           .attr("text-anchor", "middle")
           .attr("font-size", "14px")
           .attr("fill", "#666")
           .text("Write a summary and click 'Evaluate' to generate your knowledge map");
    }
    
    // Function to update knowledge map based on included and missing concepts
    function updateKnowledgeMap(includedConcepts, missingConcepts) {
        const width = document.getElementById('knowledge-map').clientWidth;
        const height = document.getElementById('knowledge-map').clientHeight || 250;
        
        // Clear previous SVG
        d3.select('#knowledge-map').html('');
        
        const svg = d3.select('#knowledge-map')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // Create nodes for all concepts
        const nodes = [
            ...includedConcepts.map(name => ({ id: name.replace(/\s+/g, '_'), name, included: true })),
            ...missingConcepts.map(name => ({ id: name.replace(/\s+/g, '_'), name, included: false }))
        ];
        
        // Create links between concepts
        const links = [];
        
        // Connect Nuclear Membrane to related concepts
        if (nodes.find(n => n.id === 'Nuclear_Membrane')) {
            if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
                links.push({ source: 'Nuclear_Membrane', target: 'Membrane-bound_Organelles', type: "related" });
            }
            if (nodes.find(n => n.id === 'Rod-shaped_Chromosomes')) {
                links.push({ source: 'Nuclear_Membrane', target: 'Rod-shaped_Chromosomes', type: "contains" });
            }
        }
        
        // Connect Cytoskeleton to related concepts
        if (nodes.find(n => n.id === 'Cytoskeleton')) {
            if (nodes.find(n => n.id === 'Intracellular_Transport')) {
                links.push({ source: 'Cytoskeleton', target: 'Intracellular_Transport', type: "enables" });
            }
            if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
                links.push({ source: 'Cytoskeleton', target: 'Membrane-bound_Organelles', type: "organizes" });
            }
        }
        
        // Connect Membrane-bound Organelles to specific organelles
        if (nodes.find(n => n.id === 'Membrane-bound_Organelles')) {
            ['Mitochondria', 'Endoplasmic_Reticulum', 'Golgi_Apparatus', 'Lysosomes', 'Peroxisomes'].forEach(org => {
                if (nodes.find(n => n.id === org)) {
                    links.push({ source: 'Membrane-bound_Organelles', target: org, type: "includes" });
                }
            });
        }
        
        // Create a force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(80))
            .force("charge", d3.forceManyBody().strength(-150))
            .force("center", d3.forceCenter(width / 2, height / 2));
        
        // Add links
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("stroke", "#3498db")
            .attr("stroke-opacity", 0.6)
            .attr("stroke-width", 2);
        
        // Add nodes
        const node = svg.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("circle")
            .attr("r", 10)
            .attr("fill", d => d.included ? "#3498db" : "#f2994a")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // Add node labels
        const label = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .enter()
            .append("text")
            .text(d => d.name)
            .attr("font-size", "10px")
            .attr("dx", 12)
            .attr("dy", 4);
        
        // Update positions on tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
    
    // Function to add chat message based on evaluation
    function addChatMessage(score, includedConcepts, missingConcepts) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;
        
        // Clear existing messages
        chatMessages.innerHTML = '';
        
        // Get current time for appropriate greeting
        const currentTime = new Date();
        let greeting = 'Hello';
        
        if (currentTime.getHours() < 12) {
            greeting = 'Good morning';
        } else if (currentTime.getHours() < 18) {
            greeting = 'Good afternoon';
        } else {
            greeting = 'Good evening';
        }
        
        // Add contextual message based on score
        let message;
        
        if (score < 30) {
            message = `${greeting} Dr. Kim,

I've evaluated your summary and it currently has a ${score}% similarity to the expert model. There's substantial room for improvement!

Your summary is missing several key concepts about eukaryotic cells. Try to include more specific details about:
${missingConcepts.slice(0, 4).map(c => '• ' + c).join('\n')}${missingConcepts.length > 4 ? '\n• And others...' : ''}

Remember, a good summary should capture all the essential information concisely. Would you like some specific examples of what to include?`;
        } else if (score < 70) {
            message = `${greeting} Dr. Kim,

I've evaluated your summary and it has a ${score}% similarity to the expert model. You're making good progress!

Your summary includes some important concepts like ${includedConcepts.slice(0, 3).join(', ')}, but it could be more comprehensive. 

Consider adding more details about:
${missingConcepts.slice(0, 3).map(c => '• ' + c).join('\n')}${missingConcepts.length > 3 ? '\n• And others...' : ''}

Keep refining your summary to include all key points from the original text. Let me know if you'd like more specific guidance!`;
        } else {
            message = `${greeting} Dr. Kim,

Great job! Your summary has a ${score}% similarity to the expert model. That's excellent work!

Your summary effectively captures the key characteristics of eukaryotic cells, including:
${includedConcepts.slice(0, 5).map(c => '• ' + c).join('\n')}${includedConcepts.length > 5 ? '\n• And others...' : ''}

${missingConcepts.length > 0 ? `For an even more complete summary, you might also mention:\n${missingConcepts.map(c => '• ' + c).join('\n')}` : 'You\'ve successfully identified and explained all the most important concepts from the learning material.'}

Is there anything specific you'd like to know more about?`;
        }
        
        const messageElement = document.createElement('div');
        messageElement.className = 'message assistant';
        messageElement.innerHTML = `<div class="message-sender">Jordan:</div><div class="message-content">${message.replace(/\n/g, '<br>')}</div>`;
        chatMessages.appendChild(messageElement);
    }
    
    // Add initial chat message
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        // Clear existing messages
        chatMessages.innerHTML = '';
        
        // Get current time for appropriate greeting
        const currentTime = new Date();
        let greeting = 'Hello';
        
        if (currentTime.getHours() < 12) {
            greeting = 'Good morning';
        } else if (currentTime.getHours() < 18) {
            greeting = 'Good afternoon';
        } else {
            greeting = 'Good evening';
        }
        
        // Add welcome message
        const message = `${greeting} Dr. Kim,

Welcome to the evaluation feature! This is where you can test your understanding of the learning material by writing a summary.

I'll evaluate your summary by analyzing how well it covers the key concepts in the topic. You'll receive:
• A similarity score (shown in the progress bar)
• A knowledge map showing included concepts (blue) and missing concepts (orange)
• A list of any concepts that were missing from your summary
• A quality rating and personalized feedback

You can view all your previous attempts and their details by clicking on them in the "Previous Attempts" section. Try writing a summary of the eukaryotic cells content in the text area, then click "Evaluate" to see your results!`;
        
        const messageElement = document.createElement('div');
        messageElement.className = 'message assistant';
        messageElement.innerHTML = `<div class="message-sender">Jordan:</div><div class="message-content">${message.replace(/\n/g, '<br>')}</div>`;
        chatMessages.appendChild(messageElement);
    }
    
    // Setup chat functionality
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-message');
    
    if (chatInput && sendButton) {
        // Send message when button is clicked
        sendButton.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message === '') return;
            
            // Add user message to UI
            addMessageToUI('user', message);
            
            // Clear input field
            chatInput.value = '';
            
            // Get current page context
            const context = {
                name: 'test_evaluation',
                url: window.location.pathname,
                title: document.title
            };
            
            // Send message to API with context
            const csrftoken = getCookie('csrftoken');
            
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    message: message,
                    context: context
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add assistant message to UI
                    addMessageToUI('assistant', data.message);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                
                // Fallback response
                const response = `I'm sorry, I encountered an issue while processing your message. 
                
Can you try rephrasing your question? I'm here to help with evaluating your summary and providing feedback on the key concepts you've included.`;
                
                addMessageToUI('assistant', response);
            });
        });
        
        // Send message when Enter key is pressed
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
    }
    
    // Helper function to add message to UI
    function addMessageToUI(sender, message) {
        if (!chatMessages) return;
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${sender}`;
        
        let senderName = sender === 'user' ? 'You:' : 'Jordan:';
        
        messageElement.innerHTML = `
            <div class="message-sender">${senderName}</div>
            <div class="message-content">${message.replace(/\n/g, '<br>')}</div>
        `;
        
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}